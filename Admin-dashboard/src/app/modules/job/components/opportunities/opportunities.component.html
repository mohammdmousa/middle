<div class="card shadow-sm border-0">
  <!-- Card Header -->
  <div class="card-header bg-gradient-primary text-white py-3">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0 pb-2 fw-semibold">
        <i class="fas fa-ad me-2"></i> الإعلانات
      </h5>
      <a routerLink="/dash/job/addAd" class="btn btn-sm btn-light">
        <i class="fas fa-plus-circle me-1"></i> إضافة إعلان
      </a>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="card-filter bg-white p-3 border-bottom">
    <form
      #filterForm="ngForm"
      (submit)="applyFilters()"
      class="row g-3 align-items-end"
    >
      <!-- Country Filter -->
      <div class="col-md-2">
        <select
          id="filterCountry"
          class="form-select form-select-sm"
          [(ngModel)]="filters.country_id"
          name="country_id"
          (change)="onCountryFilterChange()"
        >
          <option [ngValue]="null">كل البلدان</option>
          <option *ngFor="let country of countries" [ngValue]="country.id">
            {{ country.ar_name || country.en_name }}
          </option>
        </select>
      </div>

      <!-- City Filter -->
      <div class="col-md-2">
        <select
          id="filterCity"
          class="form-select form-select-sm"
          [(ngModel)]="filters.region_id"
          name="region_id"
          [disabled]="!filters.country_id"
        >
          <option [ngValue]="null">كل المدن</option>
          <option *ngFor="let city of filteredCities" [ngValue]="city.id">
            {{ city.ar_name || city.en_name }}
          </option>
        </select>
      </div>

      <!-- Category Filter -->
      <div class="col-md-2">
        <select
          id="filterCategory"
          class="form-select form-select-sm"
          [(ngModel)]="filters.category_id"
          name="category_id"
        >
          <option [ngValue]="null">كل الفئات</option>
          <option
            *ngFor="let category of mainCategories"
            [ngValue]="category.id"
          >
            {{ category.ar_name || category.en_name }}
            <span *ngIf="category.ancestors?.length > 0">
              ({{ getAncestorsNames(category.ancestors) }})
            </span>
          </option>
        </select>
      </div>

      <!-- Date From Filter -->
      <div class="col-md-2">
        <label for="filterFromDate" class="form-label small fw-bold"
          >من تاريخ</label
        >
        <input
          id="filterFromDate"
          type="date"
          class="form-control form-control-sm"
          [(ngModel)]="filters.from_date"
          name="from_date"
        />
      </div>

      <div class="col-md-2">
        <label for="filterToDate" class="form-label small fw-bold"
          >إلى تاريخ</label
        >
        <input
          id="filterToDate"
          type="date"
          class="form-control form-control-sm"
          [(ngModel)]="filters.to_date"
          name="to_date"
        />
      </div>

      <!-- Filter Buttons -->
      <div class="col-md-2 d-flex">
        <button type="submit" class="btn btn-primary btn-sm me-2 flex-grow-1">
          <i class="fas fa-filter me-1"></i> تطبيق
        </button>
        <button
          type="button"
          class="btn btn-outline-secondary btn-sm"
          (click)="resetFilters()"
        >
          <i class="fas fa-undo me-1"></i> مسح
        </button>
      </div>
    </form>
  </div>

  <!-- Ads Table -->
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width: 80px">ID</th>
            <th>الناشر</th>
            <th>الفئة</th>
            <th>البلد</th>
            <th>المدينة</th>
            <th style="width: 100px">المشاهدات</th>
            <th style="width: 100px">المشاركات</th>
            <th style="width: 200px">الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let ad of ads">
            <tr>
              <td class="fw-semibold">{{ ad.id }}</td>
              <td>
                {{ ad.publisher?.ar_name || ad.publisher?.name || "N/A" }}
              </td>
              <td>
                <span class="badge">
                  {{ ad.category?.ar_name || ad.category?.en_name || "N/A" }}
                  <span
                    *ngIf="ad.category?.ancestors?.length > 0"
                    class="ancestors"
                  >
                    ({{ getAncestorsNames(ad.category.ancestors) }})
                  </span>
                </span>
              </td>
              <td>{{ ad.country?.ar_name || ad.country?.en_name || "N/A" }}</td>
              <td>{{ ad.region?.ar_name || ad.region?.en_name || "N/A" }}</td>
              <td class="text-center">
                <span class="badge rounded-pill">
                  {{ ad.views || 0 }}
                </span>
              </td>
              <td class="text-center">
                <span class="badge rounded-pill">
                  {{ ad.shares || 0 }}
                </span>
              </td>
              <td>
                <div class="d-flex">
                  <a
                    [routerLink]="['/dash/job/detilesAd', ad.id]"
                    class="btn btn-sm btn-icon btn-outline-info me-1"
                    title="التفاصيل"
                  >
                    <i class="fas fa-eye"></i>
                  </a>
                  <button
                    class="btn btn-sm btn-icon btn-outline-primary me-1"
                    (click)="openEditModal(ad)"
                    title="تعديل"
                  >
                    <i class="far fa-edit"></i>
                  </button>
                  <button
                    class="btn btn-sm btn-icon btn-outline-danger"
                    (click)="deleteAd(ad.id)"
                    title="حذف"
                  >
                    <i class="far fa-trash-alt"></i>
                  </button>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination -->
  <div class="card-footer d-flex justify-content-between align-items-center">
    <div class="text-muted small">
      عرض {{ (currentPage - 1) * perPage + 1 }} إلى
      {{
        currentPage * perPage > totalItems ? totalItems : currentPage * perPage
      }}
      من أصل {{ totalItems }} إعلان
    </div>

    <nav aria-label="Page navigation">
      <ul class="pagination mb-0">
        <!-- Previous Button -->
        <li class="page-item" [class.disabled]="currentPage == 1">
          <a
            class="page-link"
            href="javascript:void(0)"
            (click)="goToPage('prev')"
          >
            &laquo; السابق
          </a>
        </li>

        <!-- Numeric Page Links -->
        <ng-container *ngFor="let link of links">
          <li
            *ngIf="isNumericLink(link)"
            class="page-item"
            [class.active]="link.active"
            [class.disabled]="link.url === null"
          >
            <a
              class="page-link"
              href="javascript:void(0)"
              (click)="goToPage(link.label)"
            >
              {{ link.label }}
            </a>
          </li>
        </ng-container>

        <!-- Next Button -->
        <li class="page-item" [class.disabled]="currentPage === lastPage">
          <a
            class="page-link"
            href="javascript:void(0)"
            (click)="goToPage('next')"
          >
            التالي &raquo;
          </a>
        </li>
      </ul>
    </nav>
  </div>
  <button class="btn btn-primary mt-3" (click)="exportToExcel()">
    <i class="fas fa-file-excel me-2"></i> تصدير إلى إكسل
  </button>
  <!--edite modle  *******************************-->

  <div class="modal fade" id="editAdModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title d-flex align-items-center">
            <i class="fas fa-edit me-2"></i> تعديل إعلان
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>

        <div class="modal-body p-4">
          <form #editForm="ngForm" (ngSubmit)="updateAd()">
            <!-- الصف الأول -->
            <div class="row g-3 mb-4">
              <!-- الفئة -->
              <div class="col-md-6">
                <label for="editCategory" class="form-label fw-bold">
                  <i class="fas fa-tag me-1 text-muted"></i> الفئة
                </label>
                <select
                  class="form-select border-2 py-2"
                  id="editCategory"
                  [(ngModel)]="selectedAd.category_id"
                  name="category_id"
                  required
                  (change)="loadCustomFields(selectedAd.category_id)"
                >
                  <option [ngValue]="null" disabled>اختر الفئة</option>
                  <option *ngFor="let cat of mainCategories" [ngValue]="cat.id">
                    {{ cat.ar_name || cat.en_name }}
                    <span
                      *ngIf="cat.ancestors?.length > 0"
                      class="text-muted small"
                    >
                      ({{ getAncestorsNames(cat.ancestors) }})
                    </span>
                  </option>
                </select>
              </div>

              <!-- نوع الناشر -->
              <div class="col-md-6">
                <label for="editPublisherType" class="form-label fw-bold">
                  <i class="fas fa-user-tie me-1 text-muted"></i> نوع الناشر
                </label>
                <select
                  class="form-select border-2 py-2"
                  id="editPublisherType"
                  [(ngModel)]="selectedAd.publisher_type"
                  name="publisher_type"
                  required
                  disabled
                >
                  <option value="company">شركة</option>
                  <option value="user">مستخدم</option>
                </select>
              </div>
            </div>

            <!-- الصف الثاني -->
            <div class="row g-3 mb-4">
              <!-- البلد -->
              <div class="col-md-6">
                <label for="editCountry" class="form-label fw-bold">
                  <i class="fas fa-globe me-1 text-muted"></i> البلد
                </label>
                <select
                  class="form-select border-2 py-2"
                  id="editCountry"
                  [(ngModel)]="selectedAd.country_id"
                  name="country_id"
                  required
                  (change)="onCountryChange(selectedAd.country_id)"
                >
                  <option [ngValue]="null" disabled>اختر البلد</option>
                  <option
                    *ngFor="let country of countries"
                    [ngValue]="country.id"
                  >
                    {{ country.ar_name || country.en_name }}
                  </option>
                </select>
              </div>

              <!-- المدينة -->
              <div class="col-md-6">
                <label for="editRegion" class="form-label fw-bold">
                  <i class="fas fa-city me-1 text-muted"></i> المدينة
                </label>
                <select
                  class="form-select border-2 py-2"
                  id="editRegion"
                  [(ngModel)]="selectedAd.region_id"
                  name="region_id"
                  required
                  [disabled]="!selectedAd.country_id"
                >
                  <option [ngValue]="null" disabled>اختر المدينة</option>
                  <option *ngFor="let region of cities" [ngValue]="region.id">
                    {{ region.ar_name || region.en_name }}
                  </option>
                </select>
              </div>
            </div>

            <!-- الصف الثالث - الإحداثيات -->
            <div class="row g-3 mb-4">
              <div class="col-12 mb-3">
                <div class="form-group">
                  <label class="form-label fw-bold">
                    <i class="fas fa-map-marker-alt me-1 text-muted"></i> تحديد
                    الموقع على الخريطة
                  </label>
                  <div
                    id="editLocationMap"
                    style="
                      height: 400px;
                      width: 100%;
                      border-radius: 8px;
                      border: 1px solid #ddd;
                    "
                  ></div>
                  <small class="text-muted"
                    >انقر على الخريطة لتحديد الموقع أو اسحب العلامة</small
                  >
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label fw-bold">خط العرض</label>
                  <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="selectedAd.latitude"
                    name="latitude"
                    readonly
                  />
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label class="form-label fw-bold">خط الطول</label>
                  <input
                    type="text"
                    class="form-control"
                    [(ngModel)]="selectedAd.longitude"
                    name="longitude"
                    readonly
                  />
                </div>
              </div>
            </div>

            <!-- الحقول المخصصة -->
            <div *ngIf="customFields.length > 0" class="mt-4">
              <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                  <h5 class="mb-0 d-flex align-items-center">
                    <i class="fas fa-list-ul me-2 text-primary"></i> الحقول
                    المخصصة للفئة
                  </h5>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-6" *ngFor="let field of customFields">
                      <div class="mb-3">
                        <label
                          class="form-label fw-bold d-flex align-items-center"
                        >
                          <i
                            class="fas fa-circle-notch small me-2 text-muted"
                          ></i>
                          {{ field.ar_name }}
                          <span
                            *ngIf="field.is_required"
                            class="text-danger ms-1"
                            >*</span
                          >
                        </label>

                        <!-- حقل النص -->
                        <input
                          *ngIf="field.type === 'text'"
                          type="text"
                          class="form-control border-2 py-2"
                          [ngModel]="fieldValues[field.id]"
                          (ngModelChange)="setFieldValue(field.id, $event)"
                          [name]="'field_' + field.id"
                          [required]="field.is_required"
                        />

                        <!-- حقل الرقم -->
                        <input
                          *ngIf="field.type === 'number'"
                          type="number"
                          class="form-control border-2 py-2"
                          [ngModel]="fieldValues[field.id]"
                          (ngModelChange)="setFieldValue(field.id, $event)"
                          [name]="'field_' + field.id"
                          [min]="field.min_length"
                          [max]="field.max_length"
                          [required]="field.is_required"
                        />

                        <!-- حقل النص الطويل -->
                        <textarea
                          *ngIf="field.type === 'textarea'"
                          class="form-control border-2 py-2"
                          [ngModel]="fieldValues[field.id]"
                          (ngModelChange)="setFieldValue(field.id, $event)"
                          [name]="'field_' + field.id"
                          [required]="field.is_required"
                          rows="3"
                        ></textarea>

                        <!-- حقل التاريخ -->
                        <input
                          *ngIf="field.type === 'date'"
                          type="date"
                          class="form-control border-2 py-2"
                          [ngModel]="fieldValues[field.id]"
                          (ngModelChange)="setFieldValue(field.id, $event)"
                          [name]="'field_' + field.id"
                          [required]="field.is_required"
                        />

                        <!-- حقل الاختيار -->
                        <select
                          *ngIf="field.type === 'select'"
                          class="form-select border-2 py-2"
                          [ngModel]="fieldValues[field.id]"
                          (ngModelChange)="setFieldValue(field.id, $event)"
                          [name]="'field_' + field.id"
                          [required]="field.is_required"
                        >
                          <option [value]="null" disabled>اختر خيارًا</option>
                          <option
                            *ngFor="let option of field.options"
                            [value]="option"
                          >
                            {{ option }}
                          </option>
                        </select>

                        <!-- حقل الراديو -->
                        <div *ngIf="field.type === 'radio'" class="ps-2">
                          <div
                            *ngFor="let option of field.options"
                            class="form-check"
                          >
                            <input
                              class="form-check-input"
                              type="radio"
                              [name]="'field_' + field.id"
                              [value]="option"
                              [checked]="fieldValues[field.id] === option"
                              (change)="setFieldValue(field.id, option)"
                              [required]="field.is_required"
                            />
                            <label class="form-check-label">{{ option }}</label>
                          </div>
                        </div>

                        <!-- حقل الاختيار المتعدد -->
                        <div *ngIf="field.type === 'checkbox'" class="ps-2">
                          <div
                            *ngFor="let option of field.options"
                            class="form-check"
                          >
                            <input
                              class="form-check-input"
                              type="checkbox"
                              [value]="option"
                              [checked]="
                                (fieldValues[field.id] || []).includes(option)
                              "
                              (change)="toggleCheckboxOption(field.id, option)"
                            />
                            <label class="form-check-label">{{ option }}</label>
                          </div>
                        </div>

                        <!-- حقل الملف -->
                        <div *ngIf="field.type === 'file'" class="mt-2">
                          <div class="input-group">
                            <input
                              type="file"
                              class="form-control border-2 py-2"
                              (change)="onFileChange($event, field.id)"
                              [name]="'field_' + field.id"
                            />
                          </div>
                          <small
                            *ngIf="getFileFieldValue(field.id)"
                            class="text-muted d-block mt-2"
                          >
                            <i class="fas fa-paperclip me-1"></i> الملف الحالي:
                            {{ getFileFieldValue(field.id) }}
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="modal-footer border-0 pt-4 px-0">
              <button
                type="button"
                class="btn btn-outline-secondary px-4 py-2"
                data-bs-dismiss="modal"
              >
                <i class="fas fa-times me-1"></i> إلغاء
              </button>
              <button
                type="submit"
                class="btn btn-primary px-4 py-2"
                [disabled]="!editForm.valid"
              >
                <i class="fas fa-save me-1"></i> حفظ التغييرات
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
